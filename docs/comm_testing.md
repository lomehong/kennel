# 通讯模块测试指南

本文档提供了测试通讯模块的方法和工具，包括单元测试、集成测试和手动测试。

## 单元测试

通讯模块包含了完整的单元测试，覆盖了核心功能，包括连接、消息发送和接收、断开连接等。

### 运行单元测试

```bash
# 运行所有通讯模块的单元测试
cd pkg/comm
go test -v

# 运行特定的测试
go test -v -run TestClientConnect
go test -v -run TestManagerSendReceive
```

单元测试使用内置的测试服务器，不需要外部依赖。

## 集成测试

集成测试验证通讯模块与框架的集成，确保通讯模块能够正确地工作在框架环境中。

### 运行集成测试

```bash
# 运行所有集成测试
cd test/integration
go test -v

# 运行特定的测试
go test -v -run TestAppCommIntegration
go test -v -run TestCommManagerReconnect
```

集成测试也使用内置的测试服务器，不需要外部依赖。

## 测试工具

通讯模块提供了一个测试工具，用于手动测试通讯功能。测试工具支持服务器模式和客户端模式。

### 构建测试工具

```bash
# 构建测试工具
cd tools/comm_tester
go build
```

### 服务器模式

服务器模式启动一个WebSocket服务器，等待客户端连接。

```bash
# 启动服务器
./comm_tester -server -addr localhost:8080 -path /ws
```

服务器会自动处理客户端的连接、心跳和断开连接，并打印收到的消息。

### 客户端模式

客户端模式连接到WebSocket服务器，并发送和接收消息。

```bash
# 启动客户端
./comm_tester -client -addr localhost:8080 -path /ws

# 启动客户端（交互模式）
./comm_tester -client -addr localhost:8080 -path /ws -interactive

# 启动客户端（调试模式）
./comm_tester -client -addr localhost:8080 -path /ws -log-level debug
```

在交互模式下，可以输入命令发送不同类型的消息：

```
> send event test_event
已发送事件: test_event

> send data test_data
已发送数据: test_data

> send command test_command
已发送命令: test_command

> exit
```

## 测试场景

以下是一些测试场景，用于验证通讯模块的功能：

### 基本功能测试

1. **连接测试**：客户端能够成功连接到服务器
2. **心跳测试**：客户端能够定期发送心跳消息，服务器能够回复确认
3. **消息发送测试**：客户端能够发送不同类型的消息，服务器能够接收
4. **消息接收测试**：服务器能够发送消息，客户端能够接收
5. **断开连接测试**：客户端能够正常断开连接，发送关闭消息

### 异常情况测试

1. **服务器不可用**：客户端应该能够处理服务器不可用的情况，并尝试重连
2. **连接中断**：客户端应该能够检测到连接中断，并尝试重连
3. **服务器重启**：客户端应该能够在服务器重启后重新连接
4. **网络延迟**：客户端应该能够处理网络延迟，不会丢失消息
5. **消息超时**：客户端应该能够处理消息超时，并重试或报错

### 性能测试

1. **高频消息**：客户端能够处理高频率的消息发送和接收
2. **大量连接**：服务器能够处理大量的客户端连接
3. **长时间运行**：客户端能够长时间运行，不会出现内存泄漏或性能下降

## 故障排除

如果测试过程中遇到问题，可以尝试以下方法：

1. **检查日志**：使用 `-log-level debug` 参数启动客户端，查看详细日志
2. **检查网络**：确保服务器地址和端口正确，网络连接正常
3. **检查防火墙**：确保防火墙不会阻止WebSocket连接
4. **检查服务器**：确保服务器正在运行，并且支持WebSocket
5. **检查配置**：确保配置正确，特别是服务器URL和心跳间隔

## 自动化测试

通讯模块的单元测试和集成测试已经集成到CI/CD流程中，每次提交代码都会自动运行测试。

```bash
# 运行所有测试
go test -v ./...

# 运行所有测试并生成覆盖率报告
go test -v -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
```

## 测试覆盖率

通讯模块的测试覆盖率目标是80%以上，包括：

- 客户端连接和断开连接
- 消息发送和接收
- 心跳和重连机制
- 错误处理和恢复
- 优雅终止

## 测试结果分析

测试结果应该包括以下内容：

1. **功能验证**：所有功能是否正常工作
2. **性能指标**：消息处理速度、连接数、资源消耗等
3. **稳定性**：长时间运行是否稳定
4. **错误处理**：是否能够正确处理各种错误情况
5. **兼容性**：是否能够与不同版本的服务器兼容
