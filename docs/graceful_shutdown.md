# 优雅终止功能

## 概述

优雅终止（Graceful Shutdown）是一种机制，允许应用程序在接收到终止信号时，有序地完成当前任务、释放资源并安全地退出，而不是立即终止。这对于确保数据完整性、避免资源泄漏和提供良好的用户体验至关重要。

本框架实现了完整的优雅终止机制，确保在应用程序关闭时，所有插件都能有序地完成当前任务并释放资源。

## 支持的信号

框架支持以下终止信号：

- **SIGINT**：通常由用户按下 Ctrl+C 触发
- **SIGTERM**：通常由系统或进程管理器（如 systemd）发送
- **SIGHUP**：通常在终端会话关闭时发送

当应用程序接收到这些信号中的任何一个时，将启动优雅终止流程。

## 优雅终止流程

1. **接收信号**：应用程序接收到终止信号（SIGINT、SIGTERM 或 SIGHUP）
2. **开始终止流程**：应用程序记录终止请求并开始终止流程
3. **断开通讯连接**：应用程序断开与服务器的WebSocket连接，发送关闭消息
4. **并发关闭插件**：应用程序并发地通知所有插件开始关闭
5. **等待插件完成**：应用程序等待所有插件完成当前任务并释放资源
6. **超时处理**：如果某个插件在指定时间内未能完成关闭，应用程序将强制终止该插件
7. **清理资源**：应用程序清理其他资源（如临时文件、数据库连接等）
8. **完成终止**：应用程序记录终止完成并退出

## 配置选项

可以在配置文件中设置以下与优雅终止相关的选项：

```yaml
# 优雅终止超时时间（秒）
# 如果插件在此时间内未能完成关闭，将被强制终止
shutdown_timeout: 30
```

## 插件开发者指南

作为插件开发者，您应该实现 `Shutdown` 方法，以支持优雅终止：

```go
// Shutdown 关闭插件
func (p *YourPlugin) Shutdown() error {
    // 1. 停止接受新任务

    // 2. 等待当前任务完成

    // 3. 释放资源（关闭文件、数据库连接等）

    // 4. 返回nil表示成功关闭，或返回错误
    return nil
}
```

注意事项：

- `Shutdown` 方法应该尽快完成，但也要确保所有资源都被正确释放
- 如果您的插件有后台任务，应该提供一种机制来通知这些任务停止
- 不要在 `Shutdown` 方法中执行无限期阻塞的操作
- 框架会为每个插件的 `Shutdown` 方法设置超时（默认为5秒）

## 测试优雅终止

框架提供了一个测试脚本 `test_graceful_shutdown.ps1`，用于测试优雅终止功能：

```powershell
# 运行测试脚本
.\test_graceful_shutdown.ps1
```

该脚本会：

1. 构建应用程序和测试插件
2. 启动应用程序
3. 发送终止信号
4. 验证应用程序是否正确地优雅终止

## 通讯模块的优雅终止

通讯模块实现了完整的优雅终止机制，确保在应用程序关闭时，与服务器的连接能够正确地关闭，避免连接泄漏和数据丢失。

优雅终止流程如下：

1. **停止接收新消息**：通讯模块停止接收新的消息
2. **等待消息处理完成**：通讯模块等待所有正在处理的消息完成
3. **发送关闭消息**：通讯模块向服务器发送关闭消息，通知服务器客户端即将关闭
4. **关闭WebSocket连接**：通讯模块发送WebSocket关闭帧，然后关闭连接
5. **释放资源**：通讯模块释放相关资源

通讯模块的优雅终止是有超时控制的，如果在指定时间内未能完成关闭，将强制关闭连接。默认超时时间为5秒，可以在配置文件中修改：

```yaml
# 通讯模块关闭超时时间（秒）
comm_shutdown_timeout: 5
```

## 最佳实践

- 始终实现 `Shutdown` 方法，即使您的插件没有需要清理的资源
- 使用通道（channel）来通知后台任务停止
- 设置合理的超时时间，避免终止过程过长
- 在开发和测试过程中，验证您的插件是否能够正确地优雅终止
- 记录详细的日志，以便在出现问题时进行调试
- 确保在关闭前完成所有重要的操作，如保存数据、发送确认消息等
